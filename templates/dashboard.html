{% extends "base.html" %}

{% block title %}Home - Todo App{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with Sort Controls -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="display-5 fw-bold mb-0">
                <i class="bi bi-list-check"></i> My Tasks
            </h1>
        </div>
        <div class="col-auto">
            <div class="d-flex gap-2">
                <label class="form-label mb-0">Sort By:</label>
                <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                    <option value="alpha-asc" {% if sort_by == 'alpha-asc' %}selected{% endif %}>A → Z</option>
                    <option value="alpha-desc" {% if sort_by == 'alpha-desc' %}selected{% endif %}>Z → A</option>
                    <option value="date-oldest" {% if sort_by == 'date-oldest' %}selected{% endif %}>Date: Oldest First</option>
                    <option value="date-newest" {% if sort_by == 'date-newest' %}selected{% endif %}>Date: Newest First</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Daily High Priority Reminder Notification -->
    <!-- Temporarily disabled for now -->

    <!-- View Toggle (All / Pending / Completed / Overdue) -->
    <div class="mb-3 d-flex align-items-center gap-2">
        <div id="viewToggle" class="btn-group btn-group-sm" role="group" aria-label="View Toggle">
            <button class="btn btn-outline-secondary active" data-view="all">All</button>
            <button class="btn btn-outline-secondary" data-view="pending">Pending</button>
            <button class="btn btn-outline-secondary" data-view="completed">Completed</button>
            <button class="btn btn-outline-secondary" data-view="overdue">Overdue</button>
        </div>
    </div>

    <!-- Top stats moved above lists -->
    {% if total != 0 %}
    <div class="row mb-3 gx-3 align-items-stretch">
        <div class="col-md-4">
            <div class="stat-card stat-pending rounded-4 p-3 text-white">
                <div>
                    <div class="fs-6 opacity-75"><i class="bi bi-circle"></i> Pending</div>
                    <div class="display-6 fw-bold">{{ pending|length }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card stat-success rounded-4 p-3 text-white">
                <div>
                    <div class="fs-6 opacity-75"><i class="bi bi-check-circle"></i> Completed</div>
                    <div class="display-6 fw-bold">{{ completed|length }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card stat-overdue rounded-4 p-3 text-white">
                <div>
                    <div class="fs-6 opacity-75"><i class="bi bi-exclamation-circle"></i> Overdue</div>
                    <div class="display-6 fw-bold">{{ overdue|length }}</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main two-column layout: lists (left) + calendar/clock (right) -->
    <div class="row">
        <div class="col-lg-8" id="lists-column">

    <!-- Pending Tasks Section -->
    {% if pending %}
    <div id="pending-section" class="mb-5">
        <h4 class="mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-circle text-primary"></i>
            <span>Pending Tasks ({{ pending|length }})</span>
        </h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 45%">Task</th>
                        <th style="width: 20%">Due Date</th>
                        <th style="width: 15%">Priority</th>
                        <th style="width: 20%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for todo in pending %}
                    <tr data-task-id="{{ todo.idx }}" style="cursor: pointer;">
                        <td class="fw-500">{{ todo.task }}</td>
                        <td>
                            <small class="text-muted">{{ todo.due if todo.due else 'No date' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-{{ todo.priority_color }}">{{ todo.priority }}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-success complete-btn" data-idx="{{ todo.idx }}" title="Mark Complete">
                                <i class="bi bi-check-circle"></i> Complete
                            </button>
                            <a href="/edit/{{ todo.idx }}" class="btn btn-sm btn-outline-primary" title="Edit">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-idx="{{ todo.idx }}" title="Delete">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Overdue Tasks Section -->
    {% if overdue %}
    <div id="overdue-section" class="mb-5">
        <h4 class="mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-exclamation-circle text-danger"></i>
            <span>Overdue Tasks ({{ overdue|length }})</span>
        </h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 45%">Task</th>
                        <th style="width: 20%">Due Date</th>
                        <th style="width: 15%">Priority</th>
                        <th style="width: 20%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for todo in overdue %}
                    <tr data-task-id="{{ todo.idx }}" style="cursor: pointer;">
                        <td class="fw-500">{{ todo.task }}</td>
                        <td>
                            <small class="text-muted">{{ todo.due if todo.due else 'No date' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-{{ todo.priority_color }}">{{ todo.priority }}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-success complete-btn" data-idx="{{ todo.idx }}" title="Mark Complete">
                                <i class="bi bi-check-circle"></i> Complete
                            </button>
                            <a href="/edit/{{ todo.idx }}" class="btn btn-sm btn-outline-primary" title="Edit">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-idx="{{ todo.idx }}" title="Delete">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Completed Tasks Section -->
    {% if completed %}
    <div id="completed-section" class="mb-5">
        <h4 class="mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-check-circle text-success"></i>
            <span>Completed Tasks ({{ completed|length }})</span>
        </h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 45%">Task</th>
                        <th style="width: 20%">Due Date</th>
                        <th style="width: 15%">Priority</th>
                        <th style="width: 20%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for todo in completed %}
                    <tr data-task-id="{{ todo.idx }}" style="cursor: pointer;">
                        <td class="fw-500 text-decoration-line-through text-muted">{{ todo.task }}</td>
                        <td>
                            <small class="text-muted">{{ todo.due if todo.due else 'No date' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-{{ todo.priority_color }}">{{ todo.priority }}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary complete-btn" data-idx="{{ todo.idx }}" title="Mark Incomplete">
                                <i class="bi bi-x-circle"></i> Undo
                            </button>
                            <a href="/edit/{{ todo.idx }}" class="btn btn-sm btn-outline-primary" title="Edit">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <button class="btn btn-sm btn-outline-warning save-btn" data-idx="{{ todo.idx }}" title="Save to Archives">
                                <i class="bi bi-bookmark"></i> Save
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-idx="{{ todo.idx }}" title="Delete">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not pending and not overdue and not completed %}
    <div class="alert alert-info text-center py-5">
        <i class="bi bi-inbox display-4 d-block mb-3"></i>
        <h5>No tasks yet</h5>
        <p class="text-muted mb-3">Create your first task to get started</p>
        <a href="/add" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Create Task
        </a>
    </div>
    {% endif %}

        </div>
        <div class="col-lg-4" id="side-column">
            <div class="card shadow-sm mb-3 p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Calendar</h6>
                    <small id="clock" class="text-muted"></small>
                </div>
                <div id="mini-calendar" class="w-100"></div>
            </div>
            <div class="card shadow-sm p-3">
                <h6>Quick Actions</h6>
                <div class="d-grid gap-2 mt-2">
                    <a href="/add" class="btn btn-primary btn-sm">Create Task</a>
                    <a href="/deleted" class="btn btn-outline-secondary btn-sm">View Trash</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Sort functionality
document.getElementById('sortSelect').addEventListener('change', function() {
    window.location.href = '/?sort=' + this.value;
});

// Complete task
document.querySelectorAll('.complete-btn').forEach(btn => {
    btn.addEventListener('click', async function(e) {
        e.stopPropagation();
        const idx = this.dataset.idx;
        try {
            const response = await fetch(`/complete/${idx}`, { method: 'POST' });
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});

// Delete task
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async function(e) {
        e.stopPropagation();
        if (confirm('Move this task to trash?')) {
            const idx = this.dataset.idx;
            try {
                const response = await fetch(`/delete/${idx}`, { method: 'POST' });
                if (response.ok) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    });
});

// Save task
document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async function(e) {
        e.stopPropagation();
        const idx = this.dataset.idx;
        try {
            const response = await fetch(`/save/${idx}`, { method: 'POST' });
            if (response.ok) {
                showNotification('Task saved to archives!', 'success');
                setTimeout(() => location.reload(), 800);
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error saving task', 'danger');
        }
    });
});

// View toggle functionality (All / Pending / Completed / Overdue)
(() => {
    const viewButtons = document.querySelectorAll('#viewToggle button');
    const sections = {
        pending: document.getElementById('pending-section'),
        completed: document.getElementById('completed-section'),
        overdue: document.getElementById('overdue-section')
    };

    function showView(view) {
        if (view === 'all') {
            Object.values(sections).forEach(s => { if (s) s.style.display = 'block'; });
        } else {
            Object.values(sections).forEach(s => { if (s) s.style.display = 'none'; });
            if (sections[view]) sections[view].style.display = 'block';
        }
        viewButtons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
    }

    viewButtons.forEach(b => b.addEventListener('click', () => showView(b.dataset.view)));
    // default view
    showView('all');

    // PageUp / PageDown navigation: scroll by viewport height
    document.addEventListener('keydown', function(e) {
        if (e.key === 'PageDown' || e.key === 'PageUp') {
            e.preventDefault();
            const top = window.scrollY;
            const viewport = window.innerHeight;
            if (e.key === 'PageDown') {
                window.scrollTo({ top: top + viewport, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: Math.max(0, top - viewport), behavior: 'smooth' });
            }
        }
    });
})();

// Calendar + Clock
(() => {
    function pad(n){return n<10?'0'+n:n}
    function updateClock(){
        const el = document.getElementById('clock');
        if(!el) return;
        const now = new Date();
        el.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Simple calendar render for current month
    function renderCalendar(){
        const container = document.getElementById('mini-calendar');
        if(!container) return;
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const first = new Date(year, month, 1);
        const last = new Date(year, month + 1, 0);

        let html = '<table class="table table-borderless small"><thead><tr>';
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        days.forEach(d=>html += `<th class="text-muted">${d}</th>`);
        html += '</tr></thead><tbody>';

        let dayIndex = 1 - first.getDay();
        while(dayIndex <= last.getDate()){
            html += '<tr>';
            for(let i=0;i<7;i++){
                if(dayIndex < 1 || dayIndex > last.getDate()){
                    html += '<td></td>';
                } else {
                    const isToday = dayIndex === today.getDate();
                    html += `<td class="py-1 ${isToday? 'bg-primary text-white rounded':''}">${dayIndex}</td>`;
                }
                dayIndex++;
            }
            html += '</tr>';
        }
        html += `</tbody></table><div class="text-center text-muted small mt-1">${today.toLocaleString([], {month:'long', year:'numeric'})}</div>`;
        container.innerHTML = html;
    }
    renderCalendar();
    // Refresh calendar at midnight
    setInterval(renderCalendar, 60*60*1000);
})();

</script>
{% endblock %}
